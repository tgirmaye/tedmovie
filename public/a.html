
<!DOCTYPE html>
<html>
<head>
  <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
</head>
<body>
  <button id='getAnswer'>connect</button>
  <div style="width:80vw; height:80vh; padding:10vh 10vw; background:green;">
  <video id='vid' style="width:100%; height:100%;" controls muted autoplay ></video>
  </div>
<script>
const vid=document.getElementById('vid');
const localConnection = new RTCPeerConnection();
const socket = io();

socket.on("connect", () => {
  console.log("hello")
  // either with send()
  socket.send("Hello!");

  // or with emit() and custom event names
  socket.emit("salutations", "Hello!", { "mr": "john" }, Uint8Array.from([1, 2, 3, 4]));
});

    // (async()=>{
    //   let stream= await navigator.mediaDevices.getUserMedia({video:true})
    //   //vid.srcObject = stream;
    //   localConnection.addStream(stream);
    //   let offer=await localConnection.createOffer();
    //   localConnection.setLocalDescription(offer);
    // })();
      
    vid.src="vid.mp4"
      
      vid.onplay= async ()=>{
      let stream = await vid.captureStream()
      localConnection.addStream(stream)
      let o = await localConnection.createOffer();
      localConnection.setLocalDescription(o)
      };
      
      
      
  
localConnection.onicecandidate = e =>  {
console.log(" NEW ice candidnat!! on localconnection reprinting SDP:  " +e)

 fetch("/offer",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(localConnection.localDescription)}).catch(e=>console.log(e))
 }

const sendChannel = localConnection.createDataChannel("sendChannel");
 sendChannel.onmessage =e => console.log("messsage received!!!"  + e.data )
   sendChannel.onopen = e => console.log("open!!!!");
     sendChannel.onclose =e => console.log("closed!!!!!!");
     
     

document.getElementById('getAnswer').addEventListener('click',()=>{
   fetch("/answer").then(res=>res.json()).then(data=>JSON.parse(data)).then(answer=>{
    localConnection.setRemoteDescription(answer)
    
   });
});



</script>
</body>
</html>

